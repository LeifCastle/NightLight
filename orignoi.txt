"use client";
import DreamHeader from "../components/DreamHeader";
import { useState, useRef } from "react";
import { HeaderBgContext } from "../contexts";

export default function Quick_Record() {
  //
  //---------------Variables--------------\\
  //

  //----Refs
  const dreamInput = useRef(null); //Text area where dreams are written
  const dreams = useRef({}); //Records all dreams

  //----States
  const [assignDreamIndex, setAssignDreamIndex] = useState(1); //Assigns dream entries sequential indices (keys)
  const [currentDreamIndex, setCurrentDreamIndex] = useState(1); //Current index of dream user has selected
  //Array of dream header elements (corresponds to dream entries)
  const [dreamHeaders, setDreamHeaders] = useState([
    <DreamHeader key={1} index={1} changeDream={changeDream} />,
  ]);

  //
  //---------------Functions--------------\\
  //

  //----When user creates a new dream:
  function handleNewDreamHeader() {
    setDreamHeaders([
      ...dreamHeaders,
      <DreamHeader
        key={assignDreamIndex + 1}
        index={assignDreamIndex + 1}
        changeDream={changeDream}
        userIndex={currentDreamIndex + 1}
      />,
    ]);
    dreams[`Dream${currentDreamIndex}`] = dreamInput.current.value; //Updates dream entry to be text area input value
    dreamInput.current.value = ""; //Resets the text area
    setAssignDreamIndex(assignDreamIndex + 1);
    setCurrentDreamIndex(assignDreamIndex + 1);
  }

  //----When users deletes a dream:
  function handleDeleteDreamHeader() {
    let newshit = [];
    dreamHeaders.forEach((element) => {
      if (element.key != currentDreamIndex) {
        newshit.push(element);
      }
    });
    setAssignDreamIndex(assignDreamIndex - 1);
    setDreamHeaders(newshit);
    setCurrentDreamIndex(dreamHeaders.length);
    console.log(newshit);
  }

  //----On user changes dream text:
  function handleNewText(event) {
    dreams[`Dream${currentDreamIndex}`] = event.target.value;
  }

  //----When user switches between dream tabs:
  function changeDream(event) {
    //Sets text in text area from selected dream
    if (dreams[`Dream${event.target.id}`] !== undefined) {
      dreamInput.current.value = dreams[`Dream${event.target.id}`];
    } else {
      dreamInput.current.value = "";
    }
    setCurrentDreamIndex(parseInt(event.target.id));
  }

  //
  //---------------Returned Component--------------\\
  //

  return (
    <>
      <div className="h-12 bg-stone-500 flex items-center justify-center">
        <div className="basis-1/3"></div>
        <div className="basis-1/3 text-center">
          <HeaderBgContext.Provider value={currentDreamIndex}>
            {dreamHeaders}
          </HeaderBgContext.Provider>
        </div>
        <div className="flex basis-1/3 justify-end mr-4">
          <button className="mr-2" onClick={handleDeleteDreamHeader}>
            Delete
          </button>
          <button onClick={handleNewDreamHeader}>New</button>
        </div>
      </div>
      <div className="text-black">
        <textarea
          name="textarea"
          rows="10"
          cols="50"
          placeholder="My dream..."
          ref={dreamInput}
          onChange={handleNewText}
        ></textarea>
      </div>
    </>
  );
}
